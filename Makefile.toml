[config]
skip_core_tasks = true
default_to_workspace = false

[env]
CONTRACT_TARGET = "wasm32-unknown-unknown"
BUILD_PROFILE = "release"
FDEV = "fdev" 

[tasks.build-web-container]
description = "Build the web container contract WASM"
command = "cargo"
args = ["build", "--profile", "${BUILD_PROFILE}", "--target", "${CONTRACT_TARGET}", "-p", "web-container-contract", "--target-dir", "target"]

[tasks.build-web-delegate]
description = "Build the web delegate WASM"
command = "cargo"
args = ["build", "--profile", "${BUILD_PROFILE}", "--target", "${CONTRACT_TARGET}", "-p", "web-delegate", "--target-dir", "target"]

[tasks.compress-webapp]
description = "Compress the web content into tar.xz"
script = '''
mkdir -p build
# Create a reproducible tar archive of the web content (XZ compressed)
echo "Compressing public to build/web-content.tar.xz..."
cd public && tar -cJf ../build/web-content.tar.xz *
'''

[tasks.build-signer]
description = "Build the signer tool"
command = "cargo"
args = ["build", "--release", "-p", "signer"]

[tasks.generate-keys]
description = "Generate a new keypair using the signer tool"
script = '''
mkdir -p build
# Only generate keys if they don't exist
if [ ! -f build/private_key ]; then
    echo "Generating new Ed25519 keypair..."
    cargo run -p signer -- generate --output-private build/private_key --output-public build/public_key
    echo "Generated Ed25519 keypair in build/"
else
    echo "Using existing keys in build/"
fi
'''

[tasks.sign-webapp]
description = "Sign the compressed webapp to generate metadata"
dependencies = ["compress-webapp", "generate-keys"]
script = '''
# Sign the tarball using the private key
# Use VERSION env var if set, otherwise default to 1
VERSION=${VERSION:-1}
echo "Signing webapp with version ${VERSION}..."
cargo run -p signer -- sign --private-key build/private_key --input build/web-content.tar.xz --output-metadata build/webapp.metadata --version ${VERSION}
echo "Signed webapp and generated build/webapp.metadata"
'''

[tasks.deploy-local]
description = "Deploy to LOCAL node only (for testing) with pre-flight checks"
dependencies = ["build-web-container", "sign-webapp"]
script = '''
./scripts/deploy.sh local
'''

[tasks.deploy-real]
description = "Deploy to REAL PUBLIC Freenet network with pre-flight checks"
dependencies = ["build-web-container", "sign-webapp"]
script = '''
./scripts/deploy.sh real
'''

[tasks.clean]
description = "Clean build artifacts"
script = '''
rm -rf build target
'''
